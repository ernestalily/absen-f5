<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Kelas F5 - Multi User</title>
    <style>
        /* Reset dan Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Login Page Styles */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 40px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 50px;
            max-width: 500px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .login-info {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .login-info h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .user-card {
            background: white;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .user-card p {
            color: #666;
            font-size: 0.9em;
            margin: 3px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            display: none;
        }

        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* User Badge */
        .user-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 15px;
            border-radius: 15px;
            margin-right: 10px;
            font-size: 0.85em;
        }

        /* Attendance Page Styles */
        .attendance-page {
            display: none;
        }

        .attendance-page.active {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-left .user-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .date-display {
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        /* Summary Cards */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 5px solid;
        }

        .summary-card.hadir { border-color: #28a745; }
        .summary-card.izin { border-color: #ffc107; }
        .summary-card.sakit { border-color: #17a2b8; }
        .summary-card.alpha { border-color: #dc3545; }

        .summary-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .summary-card .count {
            font-size: 2.5em;
            font-weight: bold;
        }

        .summary-card.hadir .count { color: #28a745; }
        .summary-card.izin .count { color: #ffc107; }
        .summary-card.sakit .count { color: #17a2b8; }
        .summary-card.alpha .count { color: #dc3545; }

        /* Table Container */
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        th:first-child {
            text-align: center;
            width: 60px;
        }

        th:last-child {
            text-align: center;
            width: 150px;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        td {
            padding: 15px;
        }

        td:first-child {
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        /* Status Dropdown */
        .status-select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
        }

        .status-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Status Colors */
        .status-select.hadir {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .status-select.izin {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .status-select.sakit {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }

        .status-select.alpha {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        /* Buttons */
        .button-container {
            padding: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-reset {
            background: #dc3545;
            color: white;
        }

        .btn-reset:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-export {
            background: #17a2b8;
            color: white;
        }

        .btn-export:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-history {
            background: #6c757d;
            color: white;
        }

        .btn-history:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            border-left: 5px solid;
            max-width: 400px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success { border-color: #28a745; }
        .toast.error { border-color: #dc3545; }
        .toast.info { border-color: #17a2b8; }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .btn-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                text-align: center;
            }

            .header-left h1 {
                font-size: 1.5em;
            }

            .date-display {
                font-size: 1em;
            }

            .summary {
                grid-template-columns: repeat(2, 1fr);
                padding: 20px;
            }

            .table-container {
                padding: 20px;
            }

            th, td {
                padding: 10px 5px;
                font-size: 0.9em;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .login-container {
                padding: 30px 20px;
            }

            .connection-status {
                top: 10px;
                right: 10px;
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .summary {
                grid-template-columns: 1fr;
            }

            th:first-child,
            td:first-child {
                width: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status" style="display: none;">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Terhubung ke Cloud</span>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <h1>üîê Login</h1>
                <p>Sistem Absensi Kelas F5</p>
            </div>

            <div id="errorMessage" class="error-message"></div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="userSelect">Pilih Pengguna</label>
                    <select id="userSelect" required>
                        <option value="">-- Pilih Pengguna --</option>
                        <option value="user1">Ketua - wesleyrafanatanael@gmail.com</option>
                        <option value="user2">Sekretaris 1 - ernestalily@gmail.com.com</option>
                        <option value="user3">Sekretaris 2 - roselynvalencia12@gmail.com</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Masukkan password">
                </div>

                <button type="submit" class="btn-login">Masuk</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Attendance Page -->
    <div id="attendancePage" class="attendance-page">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1>üìã Sistem Absensi Kelas F5</h1>
                    <div class="user-info">
                        <span class="user-badge" id="userRole"></span>
                        Login sebagai: <span id="loggedUser"></span>
                    </div>
                </div>
                <div class="date-display" id="currentDate"></div>
                <button class="btn-logout" onclick="logout()">üö™ Logout</button>
            </div>

            <!-- Summary Cards -->
            <div class="summary">
                <div class="summary-card hadir">
                    <h3>Hadir</h3>
                    <div class="count" id="countHadir">36</div>
                </div>
                <div class="summary-card izin">
                    <h3>Izin</h3>
                    <div class="count" id="countIzin">0</div>
                </div>
                <div class="summary-card sakit">
                    <h3>Sakit</h3>
                    <div class="count" id="countSakit">0</div>
                </div>
                <div class="summary-card alpha">
                    <h3>Alpha</h3>
                    <div class="count" id="countAlpha">0</div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama Siswa</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable">
                        <!-- Data siswa akan di-generate oleh JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Buttons -->
            <div class="button-container">
                <button class="btn btn-save" id="btnSave" onclick="saveAttendance()">
                    üíæ Simpan ke Google Sheets
                </button>
                <button class="btn btn-reset" onclick="resetToDefault()">üîÑ Reset ke Hadir Semua</button>
                <button class="btn btn-export" onclick="exportToExcel()">üìä Export ke Excel</button>
                <button class="btn btn-history" onclick="showHistory()">üìÖ Lihat Riwayat</button>
            </div>
        </div>
    </div>

    <!-- Modal History -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Riwayat Absensi</h2>
                <button class="btn-close" onclick="closeHistory()">‚úï Tutup</button>
            </div>
            <div id="historyContent">
                <!-- Content will be loaded by JavaScript -->
            </div>
        </div>
    </div>

    <!-- SheetJS Library untuk Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ===== KONFIGURASI MULTI-USER =====
        const USERS = {
            user1: {
                email: "wesleyrafanatanael@gmail.com",
                password: "KetuaGacor",
                role: "Ketua",
                name: "Ketua Kelas"
            },
            user2: {
                email: "ernestalily@gmail.com",
                password: "Sekretaris1Gacor",
                role: "Sekretaris",
                name: "Sekretaris Kelas"
            },
            user3: {
                email: "roselynvalencia12@gmail.com",
                password: "Sekretaris2Gacor",
                role: "Sekretaris",
                name: "Sekretaris Kelas"
            }
        };

        // GANTI URL INI dengan URL Google Apps Script Anda
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJTuxL7bNxJAzPebcktT7DypWws7rYpXjg1-olFBCAxj-JqYE5AWRzS9KqfSn1cM717g/exec";

        // ===== DATA SISWA =====
        const students = [
            "Alcion Ravelino Chen", "Cellestyne Lucretia Sanjaya", "Cellia Ingella Keynya Hutagaol", "Charly Septriandra Lim",
            "Christian Charlie Antonius", "Delbert Andi Wijaya", "Desniat Natalie Adiman Zebua", "Dicky Ferdinand",
            "Edward Wang", "Esra Yuliana Siringo", "Felicia Jessica Anwar", "Felix Tan",
            "Flobert Ivander", "Glen Hansel Pandapotan Butar Butar", "Harvlin Maximillian", "Jessline Aglecia",
            "Jocelyn Wunarta", "Jonathan Amadio Tanli", "Juliandro Agustian", "Kenneiza Anastasya Motani Gulo",
            "Kenzo Attila Leonardo", "Kledya Abigail Sinaga", "Max Orvin Nathanael", "Maximiliano Lexon Setiawan",
            "Michael Antonius", "Natasha Kalyani", "Nicholas Demus Tan", "Peter Elbert",
            "Reynard Loverdo", "Ricky Chen", "Roselyn Valencia", "Shalom Naomi Abigail Yaqub",
            "Steven Fernando Wijaya", "Timoses Manuel", "Veronica Kerenza", "Wesley Rafa Natanael"
        ];

        // ===== VARIABEL GLOBAL =====
        let currentUser = null;
        let isConnected = false;

        // ===== FUNGSI LOGIN =====
        function handleLogin(event) {
            event.preventDefault();
            
            const userSelect = document.getElementById('userSelect').value;
            const password = document.getElementById('password').value.trim();
            const errorMessage = document.getElementById('errorMessage');

            if (!userSelect) {
                errorMessage.textContent = '‚ùå Silakan pilih pengguna!';
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 3000);
                return;
            }

            const userData = USERS[userSelect];

            if (password === userData.password) {
                currentUser = {
                    id: userSelect,
                    email: userData.email,
                    role: userData.role,
                    name: userData.name
                };

                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAttendancePage();
                showToast(`‚úÖ Selamat datang, ${userData.role}!`, 'success');
                updateConnectionStatus(true);
            } else {
                errorMessage.textContent = '‚ùå Password salah!';
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 3000);
            }
        }

        // ===== FUNGSI LOGOUT =====
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginPage();
                showToast('üëã Anda telah logout.', 'info');
            }
        }

        // ===== FUNGSI TAMPILAN HALAMAN =====
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('attendancePage').classList.remove('active');
            document.getElementById('connectionStatus').style.display = 'none';
        }

        function showAttendancePage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('attendancePage').classList.add('active');
            document.getElementById('connectionStatus').style.display = 'flex';
            
            // Update user info
            document.getElementById('loggedUser').textContent = currentUser.email;
            document.getElementById('userRole').textContent = currentUser.role;
            
            displayCurrentDate();
            generateStudentTable();
        }

        // ===== FUNGSI STATUS KONEKSI =====
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.remove('disconnected');
                text.textContent = 'Terhubung ke Cloud';
            } else {
                dot.classList.add('disconnected');
                text.textContent = 'Offline';
            }
        }

        // ===== FUNGSI TANGGAL =====
        function getTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function displayCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = today.toLocaleDateString('id-ID', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        // ===== FUNGSI GENERATE TABEL =====
        function generateStudentTable() {
            const tableBody = document.getElementById('studentTable');
            tableBody.innerHTML = '';
            
            const todayDate = getTodayDate();
            const savedData = localStorage.getItem(`attendance_${todayDate}`);
            let attendanceData = {};
            
            if (savedData) {
                attendanceData = JSON.parse(savedData);
            } else {
                // DEFAULT: Semua siswa HADIR
                students.forEach(name => {
                    attendanceData[name] = 'H';
                });
            }

            students.forEach((name, index) => {
                const row = document.createElement('tr');
                const status = attendanceData[name] || 'H';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${name}</td>
                    <td>
                        <select class="status-select ${getStatusClass(status)}" 
                                data-student="${name}" 
                                onchange="updateStatus(this)">
                            <option value="H" ${status === 'H' ? 'selected' : ''}>Hadir</option>
                            <option value="I" ${status === 'I' ? 'selected' : ''}>Izin</option>
                            <option value="S" ${status === 'S' ? 'selected' : ''}>Sakit</option>
                            <option value="A" ${status === 'A' ? 'selected' : ''}>Alpha</option>
                        </select>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updateSummary();
        }

        function getStatusClass(status) {
            const classes = {
                'H': 'hadir',
                'I': 'izin',
                'S': 'sakit',
                'A': 'alpha'
            };
            return classes[status] || 'hadir';
        }

        // ===== FUNGSI UPDATE STATUS =====
        function updateStatus(select) {
            const value = select.value;
            select.classList.remove('hadir', 'izin', 'sakit', 'alpha');
            select.classList.add(getStatusClass(value));
            updateSummary();
        }

        // ===== FUNGSI UPDATE RINGKASAN =====
        function updateSummary() {
            const selects = document.querySelectorAll('.status-select');
            let countH = 0, countI = 0, countS = 0, countA = 0;

            selects.forEach(select => {
                const value = select.value;
                if (value === 'H') countH++;
                else if (value === 'I') countI++;
                else if (value === 'S') countS++;
                else if (value === 'A') countA++;
            });

            document.getElementById('countHadir').textContent = countH;
            document.getElementById('countIzin').textContent = countI;
            document.getElementById('countSakit').textContent = countS;
            document.getElementById('countAlpha').textContent = countA;
        }

        // ===== FUNGSI SIMPAN KE GOOGLE SHEETS (MULTI-USER) =====
        async function saveAttendance() {
            const btnSave = document.getElementById('btnSave');
            const originalText = btnSave.innerHTML;
            
            // Disable button dan tampilkan loading
            btnSave.disabled = true;
            btnSave.innerHTML = '<span class="spinner"></span> Menyimpan...';

            const todayDate = getTodayDate();
            const timestamp = new Date().toISOString();
            const selects = document.querySelectorAll('.status-select');
            const attendanceData = {};
            const dataArray = [];

            // Kumpulkan semua data
            selects.forEach(select => {
                const studentName = select.dataset.student;
                const status = select.value;
                attendanceData[studentName] = status;
                
                dataArray.push({
                    timestamp: timestamp,
                    tanggal: todayDate,
                    nama: studentName,
                    status: status,
                    user: currentUser.email,
                    role: currentUser.role
                });
            });

            try {
                // Kirim data ke Google Sheets
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveAttendance',
                        data: dataArray,
                        tanggal: todayDate,
                        user: currentUser.email,
                        role: currentUser.role
                    })
                });

                // Simpan juga ke LocalStorage sebagai backup
                localStorage.setItem(`attendance_${todayDate}`, JSON.stringify(attendanceData));
                saveToHistory(todayDate, attendanceData);

                updateConnectionStatus(true);
                showToast(`‚úÖ Data berhasil disimpan oleh ${currentUser.role}!`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                updateConnectionStatus(false);
                
                // Tetap simpan lokal meskipun gagal upload
                localStorage.setItem(`attendance_${todayDate}`, JSON.stringify(attendanceData));
                saveToHistory(todayDate, attendanceData);
                
                showToast('‚ö†Ô∏è Tersimpan lokal. Cek koneksi untuk sinkronisasi cloud.', 'error');
            } finally {
                // Restore button
                btnSave.disabled = false;
                btnSave.innerHTML = originalText;
            }
        }

        // ===== FUNGSI SIMPAN KE HISTORY =====
        function saveToHistory(date, data) {
            let history = localStorage.getItem('attendance_history');
            history = history ? JSON.parse(history) : {};
            
            history[date] = {
                data: data,
                user: currentUser.email,
                role: currentUser.role,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('attendance_history', JSON.stringify(history));
        }

        // ===== FUNGSI RESET =====
        function resetToDefault() {
            if (confirm('Reset absensi hari ini ke HADIR SEMUA?')) {
                const selects = document.querySelectorAll('.status-select');
                
                selects.forEach(select => {
                    select.value = 'H';
                    select.classList.remove('izin', 'sakit', 'alpha');
                    select.classList.add('hadir');
                });

                updateSummary();
                showToast('üîÑ Semua siswa direset ke HADIR!', 'info');
            }
        }

        // ===== FUNGSI EXPORT EXCEL =====
        function exportToExcel() {
            const history = localStorage.getItem('attendance_history');
            
            if (!history) {
                showToast('‚ö†Ô∏è Belum ada data untuk di-export!', 'error');
                return;
            }

            const historyData = JSON.parse(history);
            const excelData = [];

            // Header
            const dates = Object.keys(historyData).sort();
            const header = ['No', 'Nama Siswa', ...dates];
            excelData.push(header);

            // Data siswa
            students.forEach((student, index) => {
                const row = [index + 1, student];
                
                dates.forEach(date => {
                    const status = historyData[date].data[student] || '-';
                    row.push(status);
                });
                
                excelData.push(row);
            });

            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Buat workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Absensi");

            // Download
            const fileName = `Absensi_Kelas_F5_${getTodayDate()}_${currentUser.role}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showToast('üìä File Excel berhasil di-download!', 'success');
        }

        // ===== FUNGSI TAMPIL HISTORY =====
        function showHistory() {
            const history = localStorage.getItem('attendance_history');
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');

            if (!history) {
                content.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Belum ada riwayat absensi.</p>';
            } else {
                const historyData = JSON.parse(history);
                const dates = Object.keys(historyData).sort().reverse();

                let html = '';
                dates.forEach(date => {
                    const record = historyData[date];
                    const data = record.data;
                    let countH = 0, countI = 0, countS = 0, countA = 0;

                    Object.values(data).forEach(status => {
                        if (status === 'H') countH++;
                        else if (status === 'I') countI++;
                        else if (status === 'S') countS++;
                        else if (status === 'A') countA++;
                    });

                    html += `
                        <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h3 style="color: #667eea; margin-bottom: 5px;">üìÖ ${date}</h3>
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                Diinput oleh: ${record.role} (${record.user})
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                                    <strong style="color: #28a745;">Hadir:</strong> ${countH}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                                    <strong style="color: #ffc107;">Izin:</strong> ${countI}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                                    <strong style="color: #17a2b8;">Sakit:</strong> ${countS}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; text-align: center;">
                                    <strong style="color: #dc3545;">Alpha:</strong> ${countA}
                                </div>
                            </div>
                        </div>
                    `;
                });

                content.innerHTML = html;
            }

            modal.classList.add('active');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // ===== FUNGSI TOAST =====
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ===== INISIALISASI =====
        window.onload = function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const savedUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn === 'true' && savedUser) {
                currentUser = JSON.parse(savedUser);
                showAttendancePage();
            } else {
                showLoginPage();
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistory();
            }
        };

        // Update tanggal setiap menit
        setInterval(displayCurrentDate, 60000);
    </script>
</body>
</html>
